<!DOCTYPE html>
<html>
<head>
    <title>骑行记录与工资计算器</title>
    <style>
        .container { max-width: 600px; margin: 20px auto; }
        .input-group { margin: 10px 0; }
        .result { margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        select { margin: 10px 0; padding: 5px; width: 200px; }
        #weekDates { font-size: 0.9em; color: #666; }
        .add-week { display: flex; gap: 10px; align-items: center; }
        #bonusHistory { margin-top: 20px; display: none; }
        #bonusHistoryTable { width: 100%; border-collapse: collapse; }
        #bonusHistoryTable th, #bonusHistoryTable td { padding: 8px; border: 1px solid #ddd; }
        #uploadedImage { max-width: 300px; margin-top: 10px; }
        .button-group { display: flex; gap: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>骑行记录与工资计算器</h2>
        
        <!-- 周选择 -->
        <div class="input-group">
            <label>选择周:</label>
            <select id="weekSelector" onchange="loadWeekData()"></select>
            <div id="weekDates"></div>
        </div>
        
        <!-- 添加新周 -->
        <div class="input-group add-week">
            <label>添加新周 (选择起始日期):</label>
            <input type="date" id="newWeekDate">
            <button onclick="addNewWeek()">添加</button>
        </div>
        
        <!-- 输入区域 -->
        <div class="input-group">
            <label>星期一 (公里):</label>
            <input type="number" id="monDistance" min="0">
        </div>
        <div class="input-group">
            <label>星期二 (公里):</label>
            <input type="number" id="tueDistance" min="0">
        </div>
        <div class="input-group">
            <label>星期三 (公里):</label>
            <input type="number" id="wedDistance" min="0">
        </div>
        <div class="input-group">
            <label>星期四 (公里):</label>
            <input type="number" id="thuDistance" min="0">
        </div>
        <div class="input-group">
            <label>星期五 (公里):</label>
            <input type="number" id="friDistance" min="0">
        </div>
        <div class="input-group">
            <label>星期六 (公里):</label>
            <input type="number" id="satDistance" min="0">
        </div>
        <div class="input-group">
            <label>星期日 (公里):</label>
            <input type="number" id="sunDistance" min="0">
        </div>
        
        <!-- 上传图片 -->
        <div class="input-group">
            <label>上传图片:</label>
            <input type="file" id="imageUpload" accept="image/*" onchange="uploadImage()">
            <img id="uploadedImage" src="" alt="" style="display: none;">
        </div>
        
        <!-- 按钮组 -->
        <div class="button-group">
            <button onclick="calculate()">计算并保存</button>
            <button onclick="showBonusHistory()">列出全勤奖计算</button>
            <button onclick="deleteWeek()">删除当前周</button>
        </div>
        
        <!-- 结果显示区域 -->
        <div class="result" id="result">
            <table>
                <tr>
                    <th>日期</th>
                    <th>距离</th>
                    <th>备注</th>
                </tr>
                <tr><td>星期一</td><td id="monDist"></td><td></td></tr>
                <tr><td>星期二</td><td id="tueDist"></td><td></td></tr>
                <tr><td>星期三</td><td id="wedDist"></td><td></td></tr>
                <tr><td>星期四</td><td id="thuDist"></td><td></td></tr>
                <tr><td>星期五</td><td id="friDist"></td><td></td></tr>
                <tr><td>星期六</td><td id="satDist"></td><td id="satGoal"></td></tr>
                <tr><td>星期日</td><td id="sunDist"></td><td id="sunGoal"></td></tr>
                <tr><td><strong>一周总计</strong></td><td id="weekTotal"></td><td></td></tr>
                <tr><td><strong>本周工资</strong></td><td id="weekWage" colspan="2"></td></tr>
                <tr><td><strong>全勤奖</strong></td><td id="attendanceBonus" colspan="2"></td></tr>
                <tr><td><strong>下周全勤奖金额</strong></td><td id="nextBonus" colspan="2"></td></tr>
                <tr><td><strong>总收入</strong></td><td id="totalIncome" colspan="2"></td></tr>
            </table>
        </div>

        <!-- 全勤奖历史 -->
        <div id="bonusHistory">
            <h3>全勤奖计算历史</h3>
            <table id="bonusHistoryTable">
                <tr>
                    <th>周</th>
                    <th>日期范围</th>
                    <th>星期六距离</th>
                    <th>星期日距离</th>
                    <th>本周全勤奖</th>
                </tr>
            </table>
            <button onclick="document.getElementById('bonusHistory').style.display='none'">关闭</button>
        </div>
    </div>

    <script>
        // 保存数据到云端的函数
        async function saveToCloud(weekId, data) {
            try {
                const response = await fetch('/.netlify/functions/saveData', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ weekId, ...data }),
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                console.log('Save successful:', result);
                return result;
            } catch (error) {
                console.error('Save failed:', error);
                alert('保存失败，请检查网络或后端配置');
                throw error;
            }
        }

        // 从云端获取数据的函数
        async function getFromCloud() {
            try {
                const response = await fetch('/.netlify/functions/getData');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                console.log('Fetched data:', data);
                return data;
            } catch (error) {
                console.error('Fetch failed:', error);
                alert('获取数据失败，请检查网络或后端配置');
                return [];
            }
        }

        // 计算全勤奖直到指定周（不包括当前周的调整）
        function calculateAttendanceBonus(weeks, upToIndex) {
            let currentBonus = 20;
            for (let i = 0; i < upToIndex && i < weeks.length; i++) {
                const weekData = weeks[i];
                if (weekData.sat >= 5 && weekData.sun >= 5) {
                    currentBonus += 2;
                } else {
                    currentBonus -= 2;
                }
                currentBonus = Math.max(20, currentBonus);
            }
            return currentBonus;
        }

        // 加载已保存的周到选择器
        async function loadWeekOptions() {
            const selector = document.getElementById('weekSelector');
            selector.innerHTML = '';
            const weeks = await getFromCloud();
            const weekDataList = weeks.filter(w => w.weekId !== 'attendanceBonus');
            weekDataList.sort((a, b) => a.weekId.localeCompare(b.weekId));

            if (weekDataList.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.text = '请添加新周';
                selector.appendChild(option);
            } else {
                weekDataList.forEach(week => {
                    const option = document.createElement('option');
                    option.value = week.weekId;
                    const { start, end } = getWeekDates(week.weekId);
                    option.text = `${start} - ${end}`;
                    selector.appendChild(option);
                });
                selector.value = weekDataList[weekDataList.length - 1].weekId;
            }
        }

        // 计算某周的起止日期
        function getWeekDates(weekKey) {
            if (!weekKey || !weekKey.startsWith('week-')) return { start: '', end: '' };
            const dateStr = weekKey.replace('week-', '');
            const startDate = new Date(dateStr);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 6);
            return {
                start: startDate.toLocaleDateString('zh-CN'),
                end: endDate.toLocaleDateString('zh-CN')
            };
        }

        // 添加新周
        async function addNewWeek() {
            const newDate = document.getElementById('newWeekDate').value;
            if (!newDate) {
                alert('请选择一个日期');
                return;
            }
            const startDate = new Date(newDate);
            const day = startDate.getDay();
            const diff = (day === 0 ? -6 : 1 - day);
            startDate.setDate(startDate.getDate() + diff);

            const weekKey = `week-${startDate.toISOString().split('T')[0]}`;
            const weeks = await getFromCloud();
            const weekDataList = weeks.filter(w => w.weekId !== 'attendanceBonus');
            if (weekDataList.some(w => w.weekId === weekKey)) {
                alert('此周已存在');
                return;
            }

            const newWeekData = {
                mon: 0, tue: 0, wed: 0, thu: 0, fri: 0, sat: 0, sun: 0
            };
            await saveToCloud(weekKey, newWeekData);
            await loadWeekOptions();
            const selector = document.getElementById('weekSelector');
            if (selector.options.length > 0) {
                selector.value = weekKey;
                await loadWeekData();
            }
        }

        // 删除当前周
        async function deleteWeek() {
            const selectedWeek = document.getElementById('weekSelector').value;
            if (!selectedWeek) {
                alert('请先选择一个周');
                return;
            }

            if (confirm(`确定要删除 ${document.getElementById('weekSelector').selectedOptions[0].text} 吗？`)) {
                try {
                    await fetch('/.netlify/functions/deleteData', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ weekId: selectedWeek }),
                    });
                    const weeks = await getFromCloud();
                    const weekDataList = weeks.filter(w => w.weekId !== 'attendanceBonus' && w.weekId !== selectedWeek);
                    let newBonus = 20;
                    weekDataList.forEach(week => {
                        if (week.sat >= 5 && week.sun >= 5) {
                            newBonus += 2;
                        } else {
                            newBonus -= 2;
                        }
                        newBonus = Math.max(20, newBonus);
                    });
                    await saveToCloud('attendanceBonus', { value: newBonus });
                    await loadWeekOptions();
                    await loadWeekData();
                } catch (error) {
                    console.error('Delete failed:', error);
                    alert('删除失败，请检查后端配置');
                }
            }
        }

        // 加载选中周的数据
        async function loadWeekData() {
            let selectedWeek = document.getElementById('weekSelector').value;
            if (!selectedWeek) return;

            const weeks = await getFromCloud();
            let weekData = weeks.find(w => w.weekId === selectedWeek) || {
                mon: 0, tue: 0, wed: 0, thu: 0, fri: 0, sat: 0, sun: 0
            };

            document.getElementById('monDistance').value = weekData.mon;
            document.getElementById('tueDistance').value = weekData.tue;
            document.getElementById('wedDistance').value = weekData.wed;
            document.getElementById('thuDistance').value = weekData.thu;
            document.getElementById('friDistance').value = weekData.fri;
            document.getElementById('satDistance').value = weekData.sat;
            document.getElementById('sunDistance').value = weekData.sun;

            const { start, end } = getWeekDates(selectedWeek);
            document.getElementById('weekDates').textContent = `${start} - ${end}`;

            const imageData = localStorage.getItem(`${selectedWeek}-image`);
            const imageElement = document.getElementById('uploadedImage');
            if (imageData) {
                imageElement.src = imageData;
                imageElement.style.display = 'block';
            } else {
                imageElement.style.display = 'none';
                imageElement.src = '';
            }

            await calculate(false);
        }

        // 上传图片（仍使用本地存储）
        function uploadImage() {
            const selectedWeek = document.getElementById('weekSelector').value;
            if (!selectedWeek) {
                alert('请先选择或添加一个周');
                return;
            }

            const fileInput = document.getElementById('imageUpload');
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    localStorage.setItem(`${selectedWeek}-image`, imageData);
                    document.getElementById('uploadedImage').src = imageData;
                    document.getElementById('uploadedImage').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        // 计算和保存功能
        async function calculate(save = true) {
            let selectedWeek = document.getElementById('weekSelector').value;
            if (!selectedWeek) return;

            let distances = {
                mon: parseFloat(document.getElementById('monDistance').value) || 0,
                tue: parseFloat(document.getElementById('tueDistance').value) || 0,
                wed: parseFloat(document.getElementById('wedDistance').value) || 0,
                thu: parseFloat(document.getElementById('thuDistance').value) || 0,
                fri: parseFloat(document.getElementById('friDistance').value) || 0,
                sat: parseFloat(document.getElementById('satDistance').value) || 0,
                sun: parseFloat(document.getElementById('sunDistance').value) || 0
            };

            if (save) {
                await saveToCloud(selectedWeek, distances);
            }

            const weeks = await getFromCloud();
            const weekDataList = weeks.filter(w => w.weekId !== 'attendanceBonus');
            const currentWeekIndex = weekDataList.findIndex(w => w.weekId === selectedWeek);
            let bonusThisWeek = 0;
            let currentBonus = currentWeekIndex === 0 ? 20 : calculateAttendanceBonus(weekDataList, currentWeekIndex);
            if (currentWeekIndex >= 0) {
                bonusThisWeek = (distances.sat >= 5 && distances.sun >= 5) ? currentBonus : 0;
            }

            let nextAttendanceBonus = currentBonus;
            if (currentWeekIndex >= 0 && save) {
                nextAttendanceBonus = distances.sat >= 5 && distances.sun >= 5 ? nextAttendanceBonus + 2 : nextAttendanceBonus - 2;
                nextAttendanceBonus = Math.max(20, nextAttendanceBonus);
                await saveToCloud('attendanceBonus', { value: nextAttendanceBonus });
            }

            let total = distances.mon + distances.tue + distances.wed + 
                        distances.thu + distances.fri + distances.sat + distances.sun;
            let wage = total * 6.66;
            let totalIncome = wage + bonusThisWeek;

            document.getElementById('monDist').textContent = distances.mon + " 公里";
            document.getElementById('tueDist').textContent = distances.tue + " 公里";
            document.getElementById('wedDist').textContent = distances.wed + " 公里";
            document.getElementById('thuDist').textContent = distances.thu + " 公里";
            document.getElementById('friDist').textContent = distances.fri + " 公里";
            document.getElementById('satDist').textContent = distances.sat + " 公里";
            document.getElementById('sunDist').textContent = distances.sun + " 公里";

            document.getElementById('satGoal').textContent = 
                distances.sat >= 5 ? "达到5公里目标" : "未达5公里目标";
            document.getElementById('sunGoal').textContent = 
                distances.sun >= 5 ? "达到5公里目标" : "未达5公里目标";

            document.getElementById('weekTotal').textContent = total + " 公里";
            document.getElementById('weekWage').textContent = wage.toFixed(2) + " 元";
            document.getElementById('attendanceBonus').textContent = bonusThisWeek + " 元";
            document.getElementById('nextBonus').textContent = nextAttendanceBonus + " 元";
            document.getElementById('totalIncome').textContent = totalIncome.toFixed(2) + " 元";
        }

        // 显示全勤奖历史
        async function showBonusHistory() {
            const historyTable = document.getElementById('bonusHistoryTable');
            const tbody = historyTable.querySelector('tbody') || historyTable.createTBody();
            tbody.innerHTML = '';

            const weeks = await getFromCloud();
            const weekDataList = weeks.filter(w => w.weekId !== 'attendanceBonus');
            weekDataList.sort((a, b) => a.weekId.localeCompare(b.weekId));

            let currentBonus = 20;
            weekDataList.forEach((weekData, index) => {
                const { weekId, sat, sun } = weekData;
                const { start, end } = getWeekDates(weekId);
                const earnedBonus = (sat >= 5 && sun >= 5) ? currentBonus : 0;

                const row = tbody.insertRow();
                row.insertCell().textContent = `第${index + 1}周`;
                row.insertCell().textContent = `${start} - ${end}`;
                row.insertCell().textContent = `星期六: ${sat} 公里`;
                row.insertCell().textContent = `星期日: ${sun} 公里`;
                row.insertCell().textContent = earnedBonus + " 元";

                if (sat >= 5 && sun >= 5) {
                    currentBonus += 2;
                } else {
                    currentBonus -= 2;
                }
                currentBonus = Math.max(20, currentBonus);
            });

            document.getElementById('bonusHistory').style.display = 'block';
        }

        // 页面加载时初始化
        window.onload = async function() {
            await loadWeekOptions();
            await loadWeekData();
        };
    </script>
</body>
</html>